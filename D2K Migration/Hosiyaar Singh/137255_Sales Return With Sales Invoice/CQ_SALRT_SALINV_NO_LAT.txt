/* Formatted on 29/12/2022 10:59:35 (QP5 v5.294) */
SELECT ginview.fnc_uk uk,
       q1.rtcode,
       invoice_no,
       invoice_dt,
       invqty,
       invrate,
       days,
       q2.icode,
       qty,
       rate,
       q2.hsn_code,
       division,
       section,
       department,
       item_name
  FROM (SELECT TO_NUMBER ('@DocumentId@') rtcode,
               invoice_no,
               invoice_dt,
               invqty,
               invrate,
               rtdate - invoice_dt        days,
               t2.icode
          FROM (SELECT m.invcode,
                       scheme_docno  invoice_no,
                       TRUNC (invdt) invoice_dt,
                       sum(invqty) invqty,
                       rate          invrate,
                       icode
                  FROM salinvmain m, salinvdet d, ginview.lv_item i
                 WHERE m.invcode = d.invcode AND d.icode = i.code
                 group by m.invcode,
                       scheme_docno,
                       TRUNC (invdt),
                       rate,
                       icode) t1,
               (  SELECT tab1.icode, MAX (invcode) invcode, rtdate
                    FROM (  SELECT MAX (m.invcode) invcode, pcode, icode
                              FROM salinvmain m, salinvdet d
                             WHERE m.invcode = d.invcode
                          GROUP BY icode, pcode) tab1,
                         (SELECT m.rtcode,
                                 m.pcode,
                                 icode,
                                 TRUNC (rtdt) rtdate
                            FROM salrtmain m, salrtdet d, ginview.lv_item i
                           WHERE     m.rtcode = d.rtcode
                                 AND d.icode = i.code
                                 AND m.rtcode = TO_NUMBER ('@DocumentId@'))
                         tab2
                   WHERE tab1.PCODE = tab2.PCODE AND tab1.icode = tab2.icode
                GROUP BY tab1.icode, rtdate) t2
         WHERE t1.invcode = t2.invcode AND t1.icode = t2.icode) q1,
       (SELECT rtcode,
               icode,
               qty,
               rate,
               hsn_code
          FROM salrtdet d, ginview.lv_item i
         WHERE d.icode = i.code) q2,
       ginview.lv_item i
 WHERE q2.RTCODE = q1.rtcode AND q2.ICODE = q1.ICODE AND q2.icode = i.code