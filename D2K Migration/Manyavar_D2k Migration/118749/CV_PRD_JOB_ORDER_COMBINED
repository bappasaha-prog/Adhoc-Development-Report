DROP VIEW GINVIEW.CV_PRD_JOB_ORDER_COMBINED;

/* Formatted on 01/04/2021 13:01:02 (QP5 v5.294) */
CREATE OR REPLACE FORCE VIEW GINVIEW.CV_PRD_JOB_ORDER_COMBINED
(
   UK,
   JOBCODE,
   ITEM_TYPE,
   ASSEMBLY_ICODE,
   COMPONENT_ICODE,
   LOTCODE,
   PLAN_NO,
   QUANTITY,
   RATE,
   ITEM_REMARKS,
   DUE_DATE,
   ASS_SAITEM_CODE,
   SUB_ASSEMBLY_ITEM,
   COM_SAITEM_CODE,
   SUB_COMPONENT_ITEM,
   OPERATION_SEQ,
   JOB_DATE,
   WIPRATE
)
   BEQUEATH DEFINER
AS
   SELECT ginview.fnc_uk uk,
          jobcode,
          item_type,
          assembly_icode,
          component_icode,
          lotcode,
          plan_no,
          quantity,
          rate,
          item_remarks,
          due_date,
          ass_saitem_code,
          sub_assembly_item,
          com_saitem_code,
          sub_component_item,
          OPERATION_SEQ,
          job_date,
          vfpl.cus_fun_get_wip_rate (lotcode,
                                     assembly_icode,
                                     OPERATION_SEQ,
                                     job_date)
             wiprate
     FROM (  SELECT jobcode,
                    item_type,
                    assembly_icode,
                    component_icode,
                    t1.lotcode,
                    plan_no,
                    SUM (quantity) quantity,
                    rate,
                    item_remarks,
                    due_date,
                    ass_saitem_code,
                    sub_assembly_item,
                    com_saitem_code,
                    sub_component_item,
                    OPERATION_SEQ,
                    t2.JOB_DATE
               FROM (  SELECT d.jobcode jobcode,
                              'Assembly' item_type,
                              d.assembly_icode,
                              NULL    component_icode,
                              d.lotcode,
                              l.lotno plan_no,
                              SUM (d.qty) quantity,
                              d.job_rate rate,
                              d.remarks item_remarks,
                              d.duedt due_date,
                              d.ass_saitem_code,
                              s.sainame sub_assembly_item,
                              NULL    com_saitem_code,
                              NULL    sub_component_item,
                              D.OPERATION_SEQ
                         FROM ginssot.fact$prdjobdet d,
                              ginssot.dim$prdlotmain l,
                              ginssot.dim$prd_saitem s
                        WHERE     d.lotcode = l.code(+)
                              AND d.ass_saitem_code = s.code(+)
                     GROUP BY d.jobcode,
                              d.assembly_icode,
                              d.lotcode,
                              l.lotno,
                              d.job_rate,
                              d.remarks,
                              d.duedt,
                              d.ass_saitem_code,
                              s.sainame,
                              D.OPERATION_SEQ
                     UNION ALL
                       SELECT d.jobcode     jobcode,
                              'Component'   item_type,
                              NULL          assembly_icode,
                              d.component_icode,
                              NULL          lotcode,
                              NULL          plan_no,
                              SUM (d.qty)   quantity,
                              NULL          rate,
                              d.remarks     item_remarks,
                              NULL          due_date,
                              NULL          ass_saitem_code,
                              NULL          sub_assembly_item,
                              d.com_saitem_code com_saitem_code,
                              NULL          sub_component_item,
                              NULL          OPERATION_SEQ
                         FROM ginssot.fact$prdjobbom d, ginssot.dim$prd_saitem s
                        WHERE d.com_saitem_code = s.code(+)
                     GROUP BY d.jobcode,
                              d.component_icode,
                              d.remarks,
                              d.com_saitem_code,
                              D.OPERATION_SEQ) t1,
                    prdjobmain t2
              WHERE t1.jobcode = t2.code
           GROUP BY jobcode,
                    item_type,
                    assembly_icode,
                    component_icode,
                    t1.lotcode,
                    plan_no,
                    rate,
                    item_remarks,
                    due_date,
                    ass_saitem_code,
                    sub_assembly_item,
                    com_saitem_code,
                    sub_component_item,
                    OPERATION_SEQ,
                    t2.JOB_DATE);
